/**
 * Scripts Configuration
 * 
 * Centralized configuration for all scripts.
 * Reads from environment variables with sensible defaults.
 * 
 * Usage:
 *   import config from './config.js';
 *   console.log(config.server.url);
 */

import { fileURLToPath } from 'url';
import path from 'path';
import { existsSync, readFileSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '..');

// Load .env file manually (no external dependency)
const envPath = path.join(rootDir, '.env');
if (existsSync(envPath)) {
    const envContent = readFileSync(envPath, 'utf-8');
    envContent.split('\n').forEach(line => {
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#')) {
            const [key, ...valueParts] = trimmed.split('=');
            const value = valueParts.join('=').trim();
            if (key && value && !process.env[key]) {
                process.env[key] = value;
            }
        }
    });
}

/**
 * Script configuration with environment variable overrides
 */
const config = {
    // Server
    server: {
        host: process.env.HOST || 'localhost',
        port: parseInt(process.env.PORT || '5000', 10),
        get url() {
            return `http://${this.host}:${this.port}`;
        },
        // For health checks - always use localhost (0.0.0.0 isn't curl-able)
        get internalUrl() {
            return `http://localhost:${this.port}`;
        },
        get healthUrl() {
            return `${this.internalUrl}/health`;
        },
    },

    // Database
    database: {
        host: process.env.DB_HOST || 'localhost',
        port: parseInt(process.env.DB_PORT || '5433', 10),
    },

    // RabbitMQ
    rabbitmq: {
        url: process.env.RABBITMQ_URL || 'amqp://admin:admin123@localhost:5672',
        managementPort: parseInt(process.env.RABBITMQ_MANAGEMENT_PORT || '15672', 10),
        // For health checks - always use localhost (Docker maps ports there)
        get managementUrl() {
            return `http://localhost:${this.managementPort}`;
        },
    },

    // Kong Gateway
    kong: {
        gatewayUrl: process.env.KONG_GATEWAY_URL || 'http://localhost:8000',
        adminUrl: process.env.KONG_ADMIN_URL || 'http://localhost:8001',
        // For health checks - always use localhost (Docker maps ports there)
        get internalGatewayUrl() {
            return `http://localhost:${this.gatewayPort}`;
        },
        get internalAdminUrl() {
            return `http://localhost:${this.adminPort}`;
        },
        get gatewayHost() {
            return new URL(this.gatewayUrl).hostname;
        },
        get gatewayPort() {
            return parseInt(new URL(this.gatewayUrl).port || '8000', 10);
        },
        get adminHost() {
            return new URL(this.adminUrl).hostname;
        },
        get adminPort() {
            return parseInt(new URL(this.adminUrl).port || '8001', 10);
        },
    },

    // Observability
    observability: {
        jaegerUrl: process.env.JAEGER_URL || 'http://localhost:16686',
        prometheusUrl: process.env.PROMETHEUS_URL || 'http://localhost:9090',
        otelCollectorUrl: process.env.OTEL_COLLECTOR_URL || 'http://localhost:4318',
    },

    // Timeouts (in seconds)
    timeouts: {
        kongAdmin: parseInt(process.env.KONG_ADMIN_TIMEOUT || '30', 10),
        kongProxy: parseInt(process.env.KONG_PROXY_TIMEOUT || '45', 10),
        rabbitmq: parseInt(process.env.RABBITMQ_TIMEOUT || '30', 10),
        postgres: parseInt(process.env.POSTGRES_TIMEOUT || '30', 10),
        server: parseInt(process.env.SERVER_TIMEOUT || '60', 10),
    },

    // Vite / Client configuration (from VITE_ prefixed env vars)
    vite: {
        kongUrl: process.env.VITE_KONG_URL || 'http://localhost:8000',
        apiUrl: process.env.VITE_API_URL || 'http://localhost:5000',
        wsUrl: process.env.VITE_WS_URL || 'ws://localhost:5000/ws',
        port: 5173,  // Vite dev server port
    },

    // Platform detection
    isWindows: process.platform === 'win32',

    // Root directory
    rootDir,

    // Helper to get npm/npx command
    get npmCmd() {
        return this.isWindows ? 'npm.cmd' : 'npm';
    },
    get npxCmd() {
        return this.isWindows ? 'npx.cmd' : 'npx';
    },
};

// Log resolved configuration at startup
console.log('ðŸ“‹ Scripts Configuration Loaded:');
console.log('   Server:');
console.log(`      URL: ${config.server.url}`);
console.log(`      Health: ${config.server.healthUrl}`);
console.log('   Database:');
console.log(`      Host: ${config.database.host}:${config.database.port}`);
console.log('   RabbitMQ:');
console.log(`      URL: ${config.rabbitmq.url.replace(/:[^:@]+@/, ':****@')}`);
console.log(`      Management: ${config.rabbitmq.managementUrl}`);
console.log('   Kong Gateway:');
console.log(`      Gateway: ${config.kong.gatewayUrl}`);
console.log(`      Admin: ${config.kong.adminUrl}`);
console.log('   Observability:');
console.log(`      Jaeger: ${config.observability.jaegerUrl}`);
console.log(`      Prometheus: ${config.observability.prometheusUrl}`);
console.log(`      OTEL Collector: ${config.observability.otelCollectorUrl}`);
console.log('   Timeouts (seconds):');
console.log(`      Kong Admin: ${config.timeouts.kongAdmin}s, Proxy: ${config.timeouts.kongProxy}s`);
console.log(`      RabbitMQ: ${config.timeouts.rabbitmq}s, Postgres: ${config.timeouts.postgres}s`);
console.log(`      Server: ${config.timeouts.server}s`);
console.log('');

export default config;
