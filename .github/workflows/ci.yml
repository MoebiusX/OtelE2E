name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run check

      - name: Run unit tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage
        if: matrix.node-version == '20.x'

      - name: Archive coverage artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Print coverage summary
        if: matrix.node-version == '20.x'
        run: |
          echo "Coverage summary (short):"
          if [ -f coverage/coverage-summary.json ]; then
            node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); const t=data.total||data; console.log('Lines:', t.lines?.pct+'%','Statements:', t.statements?.pct+'%','Branches:', t.branches?.pct+'%','Functions:', t.functions?.pct+'%');"
          elif [ -f coverage/coverage-final.json ]; then
            node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('coverage/coverage-final.json')); const t=data.total||data; console.log('Lines:', t.lines?.pct+'%','Statements:', t.statements?.pct+'%','Branches:', t.branches?.pct+'%','Functions:', t.functions?.pct+'%');"
          else
            echo "No structured coverage JSON found; check the coverage artifacts for details"
          fi

      - name: Run npm audit and warn on high/critical
        run: |
          npm audit --json > audit.json || true
          node -e "const fs=require('fs'); const a=JSON.parse(fs.readFileSync('audit.json')); const vulnerabilities = a?.vulnerabilities ? Object.values(a.vulnerabilities) : (a?.advisories ? Object.values(a.advisories) : []); const sev=['high','critical']; const filtered = vulnerabilities.filter(v => (v.severity && sev.includes(v.severity.toLowerCase())) || (v?.severity_label && sev.includes(v.severity_label.toLowerCase()))); if(filtered.length){ console.warn('High/Critical vulnerabilities found (non-blocking):'); filtered.forEach(f => console.warn('-', f.name || f.module_name || f.title)); } else { console.log('No high/critical vulnerabilities found'); }"

      - name: Upload audit.json
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit
          path: audit.json

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run check

      - name: Run ESLint (warn-only)
        run: npm run lint
        continue-on-error: true
