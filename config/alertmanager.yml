# Alertmanager Configuration for KrystalineX
# Routes alerts to GoAlert webhook

global:
  # Default settings
  resolve_timeout: 5m
  
  # SMTP settings for email notifications via MailDev
  smtp_smarthost: 'maildev:1025'
  smtp_from: 'alertmanager@krystalinex.local'
  smtp_require_tls: false

# Alert routing tree
route:
  # Default receiver
  receiver: 'goalert-webhook'
  
  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'service']
  
  # Wait before sending first notification for group
  group_wait: 30s
  
  # Wait before sending updated notification for group
  group_interval: 5m
  
  # Wait before resending notification for group
  repeat_interval: 4h

  # Route specific alerts
  routes:
    # Critical alerts - immediate notification (GoAlert + ntfy backup)
    - match:
        severity: critical
      receiver: 'goalert-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: true  # Also send to next matching route
    
    - match:
        severity: critical
      receiver: 'ntfy-critical'
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts - batch notifications
    - match:
        severity: warning
      receiver: 'goalert-webhook'
      group_wait: 1m
      repeat_interval: 4h

    # Security alerts - immediate
    - match:
        service: security
      receiver: 'goalert-security'
      group_wait: 10s

# Inhibition rules - suppress notifications
inhibit_rules:
  # If critical is firing, suppress warning for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If service is down, suppress all other alerts for that service
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.+'
    equal: ['service']

# Notification receivers
receivers:
  # Default GoAlert webhook
  - name: 'goalert-webhook'
    webhook_configs:
      - url: 'http://goalert:8081/api/v2/prometheusalertmanager/incoming?token=f6101e3e-34aa-4ed2-8da9-70c9ba2eea34'
        send_resolved: true

  # Critical alerts - immediate escalation
  - name: 'goalert-critical'
    webhook_configs:
      - url: 'http://goalert:8081/api/v2/prometheusalertmanager/incoming?token=f6101e3e-34aa-4ed2-8da9-70c9ba2eea34'
        send_resolved: true
    # Email notifications via MailDev
    email_configs:
      - to: 'carlos@krystaline.io'
        send_resolved: true
        headers:
          Subject: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }} - KrystalineX'

  # Security alerts
  - name: 'goalert-security'
    webhook_configs:
      - url: 'http://goalert:8081/api/v2/generic/incoming'
        send_resolved: true
        http_config:
          authorization:
            type: Bearer
            credentials_file: /etc/alertmanager/goalert-token

  # ntfy - Free mobile push notifications (backup/secondary)
  # Configure topic in NTFY_TOPIC env var
  # Receives same alerts as GoAlert for mobile redundancy
  # Note: ntfy headers are passed via URL params since Alertmanager doesn't support custom headers
  - name: 'ntfy-mobile'
    webhook_configs:
      - url: 'https://ntfy.sh/${NTFY_TOPIC}'
        send_resolved: true
        # ntfy will use default priorities based on message content

  # ntfy for critical alerts only
  - name: 'ntfy-critical'
    webhook_configs:
      - url: 'https://ntfy.sh/${NTFY_TOPIC}?priority=urgent&tags=rotating_light,critical&title=CRITICAL+Alert'
        send_resolved: true

# Templates for notification messages
templates:
  - '/etc/alertmanager/templates/*.tmpl'
